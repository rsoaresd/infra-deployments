---
title: Keycloak
---

## Overview

[Keycloak](https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.6), deployed by RHSSO using an operator, is used as an authentication backed for the UI and dev-sandbox.

It's configured to read identities from Openshift, and use them for authenticating to Konflux.

The authentication flow has the following steps:

1. The user clicks on the login button in the UI.
2. The user is redirected to Keycloak for authentication.
3. The user should choose to login using Openshift.
4. Keycloak reads the user's identity from Openshift and returns a token to the UI.
5. When the user do an action in the ui, a request is sent to dev-sandbox with the token, dev-sandbox verifies the token using the Keycloak realm public key and authenticates the user.

## Updating Routes

The Keycloak configuration will change based on the fqdn of the cluster.
The files that should be updated are `set-ocp-idp.yaml` and `set-redirect-url.yaml`.
For getting the details of the OCP oauth server, run the following from any pod on the cluster:

bash```
curl --insecure https://openshift.default.svc/.well-known/oauth-authorization-server
```

## Updating the client secret for Openshift

Keycloak should be configured with the client secret provided by OCP (generated by the `openshift-provider` service account and secret) so it can use OCP for authenticating users.

The value of the secret is generated after the secret and service account are deployed on the cluster

The Keycloak operator doesn't update Keycloak when the change to there is a change to the client secret.

Because of this limitation, we need to configure the secret for the oauth client manually using the following steps:

In the `rhtap-auth` namespace

- Get the token of the "openshift-provider" secret
- Get the credentials for logging into keycloak from the secret "credential-keycloak" 
- Get the route for keycloak (it's named "keycloak"), and open the web ui.
- Goto administration console and login
- Goto "identity providers" and then click on "openshift-v4"
- Paste the token copied from the "openshift-provider" - secret in the "Client Secret" text box.
- Click save
